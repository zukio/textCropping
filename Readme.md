# Text Cropping - 文字部分だけを透過PNG化するフォルダ監視型アプリ

指定したディレクトリ内の画像ファイルを監視し、保存された画像に対して、文字部分のみを分離し、背景を透過出力するPNGファイルを自動生成するバックグラウンドアプリ。また、画像ファイルの追加、変更、削除のイベント情報を UDP メッセージとして送信します。

* 新規画像の保存をトリガーに、文字部分だけを透過PNG化
* フォルダ監視型: 指定フォルダ内の新規画像をリアルタイムで監視
* 開発言語: Python3 + OpenCV + pytesseract

## タスクトレイアイコン

アプリケーションが起動すると、タスクトレイにアイコンが表示されます。これにより、アプリケーションが実行中かどうかを一目で確認できます。

* アイコンを右クリックすると、メニューが表示されます。
* メニューの「設定」を選択すると、現在の監視フォルダや保存先などの設定を確認できます。
* 「Exit」オプションを選択すると、アプリケーションを安全に終了できます。

タスクトレイアイコンは、アプリケーションがバックグラウンドで実行されていることを視覚的に示し、簡単に終了できるようにするためのものです。

### 【GUI 設定項目一覧】

| 項目           | 内容             |
| ------------ | -------------- |
| 監視フォルダ       | 画像が保存されるフォルダ   |
| 保存先フォルダ      | RGBA画像の更新先     |
| クロップON/OFF   | 文字領域の切り出しの有無   |
| カラーモード       | 元画像 or 単色   |
| UDP通知ON/OFF  | UDP通知を使用するかどうか |
| UDP IP\:PORT | 通知送信先          |

## Download and Installation

1. リリースページから最新のバージョンの exe ファイルをダウンロードします。

   [リリースページへ移動](https://github.com/zukio/thumb-crafter/releases/tag/udpexe1.0)

2. 監視対象ディレクトリに「thumb_crafter」フォルダを作成し、ダウンロードした exe ファイルを保存します。

3. Tesseractのインストール

    [Tesseract Windows Installer](https://github.com/UB-Mannheim/tesseract/wiki)

    最新の安定版を選択し、インストーラーをダウンロード後、インストーラーを実行し、Tesseractをインストールします。インストール後、Tesseractの実行ファイルがシステムのパスに追加されていることを確認してください。

    注：Tesseractのインストール先は、デフォルトでは `C:\Program Files\Tesseract-OCR` です。インストール後、`PATH` 環境変数に追加するか、環境変数 `TESSERACT_PATH` にフルパスを設定してください。

## Usage

### Start App

「main」を実行すると、ディレクトリの監視を開始します。

### Stop App

終了するには、次のいずれかの方法を使用してください。

#### タスクトレイから終了（推奨）

* 画面右下のタスクトレイでアプリのアイコンを見つけます。
* アイコンを右クリックし、表示されるメニューから「Exit」を選択します。

#### タスクマネージャーから終了

* キーボードの「Ctrl」+「Alt」+「Del」キーを同時に押します。
* タスクマネージャーが起動したら、「プロセス」タブをクリックします。
* 「バックグラウンドプロセス」のリストから、実行している exe（thumb_crafter_udp）を探して、右クリックします。
* 「タスクの終了」を選択します。

## Options

オプションは、アプリケーションの exe ファイルを右クリックし、[プロパティ]を開いて、起動時引数を書き加えることで設定可能です：

```shell
text_cropping.exe --exclude_subdirectories --ip <IPアドレス> --port <ポート番号>
```

* `--exclude_subdirectories`: サブディレクトリの監視を除外します。このオプションを指定すると、指定したディレクトリのみが監視されます。
* `--target`: 監視するディレクトリのパス。相対パスまたは絶対パスを指定することができます。
* `--seconds`: サムネイルの生成に使用するフレームの秒数。
* `--ip <IPアドレス>`: UDP メッセージを送信するための宛先 IP アドレスを指定します。
* `--port <ポート番号>`: UDP メッセージを送信するための宛先ポート番号を指定します。
* `--delay`: UDP の連投を防ぐため後続のイベントを待機する秒数。
* `--output_dir`: 処理後のファイルを保存するディレクトリを指定します。監視対象ディレクトリと同じ場所やそのサブディレクトリを指定すると警告が表示され、出力先は監視対象の親ディレクトリに自動で変更されます。
* `--disable_udp`: UDP 通知を無効にします。
* `--disable_svg`: 文字アウトラインSVGの出力を無効にします。
* `--no_console`: コンソール入力なしでバックグラウンド実行します。
* `--config`: 設定ファイルのパスを指定します。デフォルトは `config.json`。
* `--crop`: 文字領域のみを切り出して保存します。
* `--color_mode`: `original` (元画像の色を使用) または `mono` (単色で描画) を指定します。
* `--color`: `--color_mode` が `mono` の場合に使用する色を `#RRGGBB` 形式または `R,G,B` 形式で指定します。
* `--ocr_engine`: 使用する OCR エンジンを `tesseract`, `easyocr`, `saas`, `none` から選択します。`none` を指定すると OCR 処理を行わず、画像全体を対象に処理します。

設定ファイルでは起動時引数と同じ項目を JSON 形式で指定できます。設定ファイルを読み込んだ後、起動時に渡された引数があればその値で上書きされます。

注：デフォルトでは、IP アドレスは`localhost`、ポート番号は`12345`、後続のイベントを待機する秒数 は `1` 秒間です。

注：--target 引数が指定されなかった場合は、Python プロジェクトフォルダが置かれたディレクトリが監視されます。

注：--seconds 引数が指定されなかった場合、またはビデオの長さが指定された秒未満の場合は、最初のフレームが使用されます。

### 出力先フォルダ指定

* RGBA画像の保存先を指定可

### クロップ機能

* 入力の解像度を保持するか、文字領域の範囲でクロップして画像を切り出すかどうかを設定可
* 使用者のON/OFF選択形式 (`--crop` オプション)

### カラーモード選択

* 「元画像を利用して透過化」 or 「指定の単色」 を選択可 (`--color_mode` と `--color` オプション)

### 出力先フォルダ指定

* RGBA画像の保存先を指定可

### UDP通知

* 出力完了後に、UDP通知を送信する機能

    最初の更新から 1 秒間無更新状態が続いた時点で一度だけ UDP が送信されます。
    ファイルの追加・削除が連続して発生した場合でも、連続して UDP が送信されることはありません。
  
    ``` bash
    {
      event:[{ type:event-type, path:filepath }],
      files:video_files
    }
    ```

* **event**: 発生したイベントが新しい順に追加され、1 秒間の無更新状態が続いた時点ですべてのイベントの情報を新しい順に配列にまとめて送信します
* **files**: 対象ファイルが追加・削除されるたびにリストが更新されるため、ファイルリストは常に最新の状態を保持します。

### 【テキスト認識精度向上について】

テキスト認識の精度を向上させるために、複数OCRエンジンのサポート機能が追加されました：

* `pytesseract` (デフォルト): 基本的なOCR機能
* `EasyOCR`: 高精度な多言語OCR (オプション)
* `saas`: Google Cloud Vision API を使用 (オプション)
* `none`: OCRを使用せず、画像全体を処理 (オプション)

`config.json` または `--ocr_engine` オプションで OCR エンジンを設定できます:

## Logs

ログファイルに実行ログを出力します。ログファイルは`./logs/`ディレクトリ内に日付ごとに作成されます。ログレベルは INFO です。

## For Custom

開発ソースを使用するには：

1. リポジトリをクローンします。

   ```shell
   git clone https://github.com/zukio/text-cropping.git
   ```

2. プロジェクトのディレクトリに移動します。

   ```shell
   cd text-cropping
   ```

3. 必要な Python パッケージをインストールします。

   ```shell
   pip install -r requirements.txt
   ```

4. [Tesseract Windows Installer](https://github.com/UB-Mannheim/tesseract/wiki) をインストールします。Tesseract の実行ファイルが `PATH` に含まれていない場合は、環境変数 `TESSERACT_PATH` にフルパスを設定してください。

5. [potrace](http://potrace.sourceforge.net/) をインストールし、実行ファイルへのパスを環境変数 `POTRACE_PATH` または `PATH` に追加します。SVG 出力機能を利用する場合に必須です。

6. main.py スクリプトを使用して、ディレクトリの監視とサムネイル生成を開始します。

   ```shell
   python main.py --exclude_subdirectories --target <監視対象ディレクトリ> --seconds 2 --ip <IPアドレス> --port <ポート番号> --delay 3
   ```

## 【拡張性】

* OCR読み取り結果をログ/テキストファイルに出力
* 文字のレイアウト情報をJSONとして保存
* マスクをSVGで保存
